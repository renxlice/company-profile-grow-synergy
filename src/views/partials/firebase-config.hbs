<script>
    // Initialize Firebase
    let db;
    try {
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
            throw new Error('Firebase SDK not loaded');
        }

        // Firebase configuration from server
        const firebaseConfig = {
            apiKey: "{{firebaseApiKey}}",
            authDomain: "{{firebaseAuthDomain}}",
            projectId: "{{firebaseProjectId}}",
            storageBucket: "{{firebaseStorageBucket}}",
            messagingSenderId: "{{firebaseMessagingSenderId}}",
            appId: "{{firebaseAppId}}",
            measurementId: "{{firebaseMeasurementId}}"
        };

        console.log('Firebase config from server:', firebaseConfig);

        // Initialize Firebase only if not already initialized
        if (!firebase.apps.length) {
            firebase.initializeApp({
                ...firebaseConfig,
                appId: firebaseConfig.appId,
                measurementId: firebaseConfig.measurementId
            });
            console.log('Firebase initialized successfully');
        } else {
            console.log('Firebase already initialized, skipping...');
        }

        // Initialize services
        db = firebase.firestore();
        window.db = db; // Make db globally available
        
        // Initialize Analytics if available
        if (typeof firebase.analytics === 'function') {
            const analytics = firebase.analytics();
            window.analytics = analytics; // Make analytics globally available
            console.log('Firebase Analytics initialized');
        } else {
            console.warn('Firebase Analytics not available');
        }

        console.log('Firebase services ready - DB:', !!db, 'Analytics:', !!window.analytics);
        
    } catch (error) {
        console.error('Firebase initialization failed:', error);
        // Fallback to mock mode if Firebase fails
        db = {
            collection: () => ({
                get: async () => ({ docs: [] }),
                add: async () => ({ get: async () => ({ id: 'mock-id', data: () => ({}) }) }),
                doc: () => ({
                    get: async () => ({ exists: false, id: 'mock-id', data: () => ({}) }),
                    update: async () => {},
                    delete: async () => {}
                }),
                limit: () => ({ get: async () => ({ docs: [] }) }), // Add limit method
                orderBy: () => ({ get: async () => ({ docs: [] }) }) // Add orderBy method
            }),
        };
        window.db = db;
        console.warn('Using mock Firebase mode');
    }
</script>
