<script>
    // Initialize Firebase
    let db;
    
    // Mock Firestore function for fallback
    function createMockFirestore() {
        console.warn('üîÑ Using mock Firestore mode');
        return {
            collection: (collectionName) => ({
                get: async () => ({ 
                    docs: [],
                    empty: true,
                    size: 0
                }),
                add: async () => ({ 
                    get: async () => ({ id: 'mock-' + Date.now(), data: () => ({}) }) 
                }),
                doc: (docId) => ({
                    get: async () => ({ 
                        exists: false, 
                        id: docId || 'mock-id', 
                        data: () => ({}) 
                    }),
                    update: async () => ({ success: true }),
                    delete: async () => ({ success: true })
                }),
                limit: () => ({ 
                    get: async () => ({ docs: [], empty: true, size: 0 }) 
                }),
                orderBy: () => ({ 
                    get: async () => ({ docs: [], empty: true, size: 0 }) 
                }),
                where: () => ({ 
                    get: async () => ({ docs: [], empty: true, size: 0 }) 
                })
            })
        };
    }
    try {
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
            throw new Error('Firebase SDK not loaded');
        }

        // Firebase configuration from server
        const firebaseConfig = {
            apiKey: "{{firebaseApiKey}}",
            authDomain: "{{firebaseAuthDomain}}",
            projectId: "{{firebaseProjectId}}",
            storageBucket: "{{firebaseStorageBucket}}",
            messagingSenderId: "{{firebaseMessagingSenderId}}",
            appId: "{{firebaseAppId}}",
            measurementId: "{{firebaseMeasurementId}}"
        };

        console.log('Firebase config from server:', firebaseConfig);

        // Initialize Firebase only if not already initialized
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully');
            
            // Initialize Firestore with error handling
            try {
                db = firebase.firestore();
                
                // Test connection with a simple read operation
                db.collection('_connection_test').limit(1).get()
                    .then(() => {
                        console.log('‚úÖ Firebase Firestore connection successful!');
                    })
                    .catch((error) => {
                        console.warn('‚ö†Ô∏è Firebase Firestore connection warning:', error.message);
                        if (error.code === 'permission-denied') {
                            console.warn('üìã Firebase Setup Checklist:');
                            console.warn('1. Ensure Firestore API is enabled in Google Cloud Console');
                            console.warn('2. Check Firestore security rules allow read access');
                            console.warn('3. Verify project ID matches your Firebase project');
                            console.warn('4. Confirm API key has correct permissions');
                        }
                    });
                    
                window.db = db;
            } catch (firestoreError) {
                console.error('‚ùå Firestore initialization failed:', firestoreError);
                // Fallback to mock mode
                db = createMockFirestore();
                window.db = db;
            }
        } else {
            console.log('Firebase already initialized, skipping...');
            db = firebase.firestore();
            window.db = db;
        }
        
        // Initialize Analytics if available
        if (typeof firebase.analytics === 'function') {
            const analytics = firebase.analytics();
            window.analytics = analytics; // Make analytics globally available
            console.log('Firebase Analytics initialized');
        } else {
            console.warn('Firebase Analytics not available');
        }

        console.log('Firebase services ready - DB:', !!db, 'Analytics:', !!window.analytics);
        
    } catch (error) {
        console.error('Firebase initialization failed:', error);
        // Fallback to mock mode if Firebase fails
        db = createMockFirestore();
        window.db = db;
        console.warn('Using mock Firebase mode due to initialization failure');
    }
</script>
